<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æœƒå“¡æœå‹™</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #06c755; --bg: #f2f4f6; --text: #2c3e50;
      --card-shadow: 0 10px 20px rgba(0,0,0,0.05); --red: #ff3b30;
      --gold: linear-gradient(135deg, #f1c40f, #f39c12);
      --platinum: linear-gradient(135deg, #bdc3c7, #2c3e50);
      --diamond: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      --black-gold: linear-gradient(135deg, #2c3e50, #000); 
    }
    body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; }
    .container { padding: 20px; max-width: 500px; margin: 0 auto; }
    #page-loading { background: var(--bg); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .loader { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .member-card { background: linear-gradient(135deg, #2ecc71, #06c755); color: white; border-radius: 20px; padding: 25px; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-bottom: 20px; min-height: 140px; }
    .member-card::before { content: ""; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; position: relative; z-index: 1; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); object-fit: cover; background: #fff; }
    .user-details h2 { margin: 0; font-size: 20px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .vip-tag { font-size: 12px; font-weight: bold; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); margin-top: 5px; display: inline-block; }
    .card-body { position: relative; z-index: 1; text-align: right; }
    .balance-amount { font-size: 36px; font-weight: 700; letter-spacing: 1px; }
    
    .member-code-box { 
      font-size: 13px; background: rgba(0,0,0,0.2); padding: 6px 12px; border-radius: 20px; 
      display: inline-flex; align-items: center; gap: 6px; margin-top: 10px; color: #eee; letter-spacing: 1px;
      cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .member-code-box:active { background: rgba(0,0,0,0.4); transform: scale(0.96); }

    #toast-msg {
      visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center;
      border-radius: 50px; padding: 12px; position: fixed; z-index: 9999;
      left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 14px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s;
    }
    #toast-msg.show { visibility: visible; opacity: 1; bottom: 110px; }

    .action-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 15px; }
    .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-green { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3); }
    .btn-outline { background: transparent; border: 1px solid #ddd; color: #666; }
    
    .service-card { background: #fff; padding: 16px; border-radius: 12px; border: 2px solid transparent; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: var(--card-shadow); transition: all 0.2s; margin-bottom:10px; }
    .service-card.active { border-color: var(--primary); background: #f0fff4; }
    
    .pill-group { display: flex; gap: 10px; }
    .pill-btn { flex: 1; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s; }
    .pill-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 10px; font-size: 16px; background: #fff; outline: none; box-sizing: border-box; }
    
    .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .time-slot { padding: 10px; text-align: center; border: 1px solid #eee; border-radius: 8px; background: #fff; color: #333; cursor: pointer; }
    .time-slot.busy { background: #f5f5f5 !important; color: #ccc !important; pointer-events: none; }
    .time-slot.selected { background: var(--primary) !important; color: white !important; }

    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; z-index: 100; }
    .page { display: none; animation: fadeIn 0.3s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Modal */
    #custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 20px; text-align: center; max-height: 80vh; overflow-y: auto; }
    .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    
    .history-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
    .history-item:last-child { border-bottom: none; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .status-success { background: #e8f8f0; color: #06c755; }
    .status-pending { background: #fff5e6; color: #f39c12; }
    
    .badge-container { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { padding: 8px 16px; background: #fff; border: 1px solid #eee; border-radius: 30px; cursor: pointer; }
    .badge.active { background: var(--primary); color: white; border-color: var(--primary); }
    .badge.add { border: 1px dashed var(--primary); color: var(--primary); }
    
    .bank-info-box { background: #f0f9ff; padding: 15px; border-radius: 10px; text-align: left; border-left: 4px solid #3498db; margin-bottom: 15px; }
    .bank-info-row { font-size: 14px; margin-bottom: 5px; color: #2c3e50; }
    .bank-highlight { font-weight: bold; font-size: 15px; color:#0056b3; }

    .benefit-card { border-radius: 16px; padding: 20px; margin-bottom: 15px; color: white; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .benefit-card h3 { margin: 0 0 15px 0; font-size: 20px; color: white; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; }
    .benefit-card ul { margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8; }
    .benefit-card li { margin-bottom: 8px; }
    .benefit-card.gold { background: var(--gold); }
    .benefit-card.platinum { background: var(--platinum); }
    .benefit-card.diamond { background: var(--diamond); }
    .benefit-note { font-size: 12px; color: #888; text-align: center; margin-top: 20px; line-height: 1.6; background: #fff; padding: 15px; border-radius: 10px; }
    .referral-card { background: #fff0f6; border-left: 4px solid #e91e63; color: #333; }
    .referral-card h3 { color: #e91e63; border-bottom: 1px solid #ffc1e3; }
    
    /* â˜…â˜…â˜… æ–°å¢å­¸å“¡è¡¨å–®å„ªåŒ– â˜…â˜…â˜… */
    #new-student-form { background: #fafafa; padding: 20px; border-radius: 15px; border: 1px solid #eee; margin-top: 15px; }
    .input-label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; font-weight: bold; }
  </style>
</head>
<body>

  <div id="page-loading">
    <div class="loader"></div>
    <p style="color:#999; margin-top:15px; font-size:14px;">ç³»çµ±é€£ç·šä¸­...</p>
  </div>

  <div id="toast-msg">å·²è¤‡è£½æ¨è–¦ç¢¼ï¼</div>

  <div id="page-register" class="page">
    <div class="container">
      <div class="action-card">
        <label class="input-label">å§“å</label><input type="text" id="regName" style="margin-bottom:15px;">
        <label class="input-label">é›»è©±</label><input type="tel" id="regPhone" style="margin-bottom:15px;">
        <label class="input-label">ç”Ÿæ—¥</label><input type="date" id="regBirth" style="margin-bottom:15px;">
        <label class="input-label">æ¨è–¦äººä»£ç¢¼ (é¸å¡«)</label>
        <input type="text" id="regReferrer" placeholder="è¼¸å…¥6ç¢¼æ¨è–¦ç¢¼" style="text-transform:uppercase;">
        <button class="btn-main btn-green" style="margin-top:20px;" onclick="doRegister()">ç¢ºèªç¶å®š</button>
      </div>
    </div>
  </div>

  <div id="page-profile" class="page">
    <div class="container">
      <div class="member-card" id="memberCardBg">
        <div class="card-header">
          <div class="user-info">
            <img id="profileAvatar" class="avatar" src="">
            <div class="user-details">
              <h2 id="profileName">--</h2>
              <span id="profileLevel" class="vip-tag">ä¸€èˆ¬æœƒå“¡</span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="balance-label">ç¾æœ‰é»æ•¸</div>
          <div class="balance-amount"><span id="profileBalance">0</span><span class="currency">P</span></div>
          <div id="myMemberCode" class="member-code-box" onclick="copyMemberCode()" data-code="">
             æ¨è–¦ç¢¼: -- <span style="font-size:14px; margin-left:3px;">ğŸ“‹</span>
          </div>
        </div>
      </div>

      <div style="display:grid; gap:15px; margin-bottom:20px;">
        <div class="action-card" onclick="switchPage('page-booking')" style="cursor:pointer; display:flex; align-items:center; gap:15px;">
          <div style="font-size:24px;">ğŸ“…</div>
          <div style="flex-grow:1;">
            <div style="font-weight:bold;">ç«‹å³é ç´„</div>
            <div style="color:#888; font-size:13px;">é ç´„èª²ç¨‹</div>
          </div>
          <div>â€º</div>
        </div>
        
        <div class="action-card" onclick="switchPage('page-topup-history')" style="cursor:pointer; display:flex; align-items:center; gap:15px;">
           <div style="font-size:24px;">ğŸ’°</div>
           <div style="flex-grow:1;">
             <div style="font-weight:bold;">å„²å€¼ç´€éŒ„</div>
             <div style="color:#888; font-size:13px;">æŸ¥çœ‹å„²å€¼èˆ‡ç‹€æ…‹</div>
           </div>
           <div>â€º</div>
        </div>

        <div class="action-card" onclick="switchPage('page-benefits')" style="cursor:pointer; display:flex; align-items:center; gap:15px;">
           <div style="font-size:24px;">ğŸ’</div>
           <div style="flex-grow:1;">
             <div style="font-weight:bold;">æœƒå“¡æ¬Šç›Š</div>
             <div style="color:#888; font-size:13px;">æŸ¥çœ‹ç­‰ç´šå„ªæƒ </div>
           </div>
           <div>â€º</div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ğŸ“‹ æœ€è¿‘é ç´„</h3>
        <div onclick="switchPage('page-all-history')" style="color:var(--primary); font-size:14px; cursor:pointer;">é¡¯ç¤ºå…¨éƒ¨ â€º</div>
      </div>
      <div class="action-card" id="history-list">
        <div style="text-align:center; color:#999; padding:10px;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <div id="page-all-history" class="page">
    <div style="background:rgba(255,255,255,0.9); padding:15px; display:flex; align-items:center;">
      <button class="btn-outline" onclick="handleBookingBack()" style="border:none; font-size:20px;">â€¹</button>
      <div style="flex-grow:1; text-align:center; font-weight:bold;">é ç´„ç´€éŒ„</div>
      <div style="width:20px;"></div>
    </div>
    <div class="container">
      <div class="action-card" id="all-history-list">
        <div style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</div>
      </div>
      <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
        <button class="btn-outline" id="btn-prev-page" onclick="changePage(-1)" style="width:auto; padding:5px 20px;">ä¸Šä¸€é </button>
        <span id="page-indicator" style="line-height:36px;">1 / 1</span>
        <button class="btn-outline" id="btn-next-page" onclick="changePage(1)" style="width:auto; padding:5px 20px;">ä¸‹ä¸€é </button>
      </div>
    </div>
  </div>

  <div id="page-benefits" class="page">
    <div style="background:rgba(255,255,255,0.9); padding:15px; display:flex; align-items:center;">
      <button class="btn-outline" onclick="handleBookingBack()" style="border:none; font-size:20px;">â€¹</button>
      <div style="flex-grow:1; text-align:center; font-weight:bold;">æœƒå“¡æ¬Šç›Š</div>
      <div style="width:20px;"></div>
    </div>
    <div class="container">
      <div class="benefit-card referral-card">
        <h3>MGM æ¨è–¦çå‹µ</h3>
        <ul>
          <li><strong>é‚€è«‹å¥½å‹ï¼š</strong>å°‡æ‚¨çš„æ¨è–¦ç¢¼åˆ†äº«çµ¦å¥½å‹ã€‚</li>
          <li><strong>å¥½å‹å„ªæƒ ï¼š</strong>å¥½å‹è¨»å†Šæ™‚è¼¸å…¥æ‚¨çš„æ¨è–¦ç¢¼ã€‚</li>
          <li><strong>å›é¥‹çå‹µï¼š</strong>ç•¶å¥½å‹å–®ç­†æ¶ˆè²»æ»¿ 500 é»ï¼Œç³»çµ±å°‡è‡ªå‹•å›é¥‹æ‚¨ <strong>200 é»</strong>ï¼</li>
        </ul>
      </div>
      <div class="benefit-card gold">
        <h3>VIP1 é»ƒé‡‘æœƒå“¡</h3>
        <ul>
          <li><strong>è¦‹é¢ç¦®ï¼š</strong>è´ˆé€300é»</li>
          <li><strong>ç”Ÿæ—¥ç¦®ï¼š</strong>ç”Ÿæ—¥ç•¶æœˆæœå‹™è²»å–®æ¬¡9æŠ˜åˆ¸</li>
          <li><strong>å„²å€¼å›é¥‹ï¼š</strong>å„²1000é€100ï¼Œä¾æ­¤é¡æ¨~</li>
        </ul>
      </div>
      <div class="benefit-card platinum">
        <h3>VIP2 ç™½é‡‘æœƒå“¡</h3>
        <ul>
          <li><strong>æ™‰å‡æ¢ä»¶ï¼š</strong>å–®ç­†å„²å€¼1è¬ æˆ– ç´¯ç©2è¬</li>
          <li><strong>æœå‹™æŠ˜æ‰£ï¼š</strong>å…¨é¤¨ 95 æŠ˜</li>
          <li><strong>ç”Ÿæ—¥ç¦®ï¼š</strong>å°ˆå±¬å¯¦é«”å°ç¦®ç‰© (åƒ¹å€¼$200+)</li>
          <li><strong>å„²å€¼å›é¥‹ï¼š</strong><br>å„²1000é€110... (ç•¥)<br>å„²5000ä»¥ä¸Šï¼Œæœ¬é‡‘ä¹˜ä»¥1.12å€</li>
        </ul>
      </div>
      <div class="benefit-card diamond">
        <h3>VIP3 é‘½çŸ³æœƒå“¡</h3>
        <ul>
          <li><strong>æ™‰å‡æ¢ä»¶ï¼š</strong>å–®ç­†å„²å€¼3è¬ æˆ– ç´¯ç©8è¬</li>
          <li><strong>æœå‹™æŠ˜æ‰£ï¼š</strong>å…¨é¤¨ 9 æŠ˜</li>
          <li><strong>è¦ªå‹å…±äº«ï¼š</strong>å¯è¨­å®š2ä½è¦ªå‹åŒäº«æŠ˜æ‰£</li>
          <li><strong>ç”Ÿæ—¥ç¦®ï¼š</strong>ç”Ÿæ—¥ç•¶æœˆã€Œå…è²»è´ˆé€ä¸€å ‚èª²ã€åŠã€Œç²¾ç¾ç¦®å“ã€</li>
          <li><strong>å„²å€¼å›é¥‹ï¼š</strong>1.15å€ (ä¾‹:å„²1è¬é€1500)</li>
        </ul>
      </div>
      <div class="benefit-note">
        ğŸ’¡ <strong>è²¼å¿ƒæé†’ï¼š</strong><br>
        é»æ•¸å¯æ°¸ä¹…ä½¿ç”¨ï¼Œæœªæ¶ˆè²»ä¸æœƒæ¸…ç®—ã€‚<br>
        è‹¥è¶…éä¸‰å€‹æœˆæœªæ¶ˆè²»ï¼Œæœƒå“¡å±¤ç´šå„ªæƒ å°‡æš«æ™‚å‡çµï¼Œ<br>
        åªéœ€é€²è¡Œä¸€æ¬¡æ¶ˆè²»å³å¯æ¢å¾©åŸæœƒå“¡å±¤ç´šã€‚
      </div>
    </div>
  </div>

  <div id="page-topup-history" class="page">
    <div style="background:rgba(255,255,255,0.9); padding:15px; display:flex; align-items:center;">
      <button class="btn-outline" onclick="handleBookingBack()" style="border:none; font-size:20px;">â€¹</button>
      <div style="flex-grow:1; text-align:center; font-weight:bold;">å„²å€¼ç´€éŒ„</div>
      <div style="width:20px;"></div>
    </div>
    <div class="container">
      <button class="btn-main btn-green" style="margin-bottom:20px;" onclick="showTopupFlow()">ï¼‹ ç«‹å³å„²å€¼</button>
      <div class="action-card" id="topup-list"><div style="text-align:center; color:#999; padding:10px;">è¼‰å…¥ä¸­...</div></div>
    </div>
  </div>

  <div id="page-booking" class="page">
    <div style="background:rgba(255,255,255,0.9); padding:15px; display:flex; align-items:center;">
      <button class="btn-outline" onclick="handleBookingBack()" style="border:none; font-size:20px;">â€¹</button>
      <div style="flex-grow:1; text-align:center; font-weight:bold;">é ç´„èª²ç¨‹</div>
      <div style="width:20px;"></div>
    </div>
    <div class="container" style="padding-top:10px;">
      <h3>1. é¸æ“‡æœå‹™</h3><div id="service-list"></div>
      <h3>2. æ™‚é•·</h3><div class="pill-group"><div class="pill-btn active" onclick="selectDuration(60, this)">1 H</div><div class="pill-btn" onclick="selectDuration(90, this)">1.5 H</div><div class="pill-btn" onclick="selectDuration(120, this)">2 H</div></div>
      <h3>3. æ™‚é–“</h3><div class="action-card"><input type="date" id="dateSelect" onchange="renderSlots()" style="margin-bottom:15px;"><div id="slotsContainer" class="time-grid"></div></div>
      
      <h3>4. å­¸å“¡</h3>
      <div class="action-card">
        <div id="student-container" class="badge-container"></div>
        
        <div id="new-student-form" style="display:none;">
          <label class="input-label">å­¸å“¡å§“å</label>
          <input type="text" id="newChildName" placeholder="è¼¸å…¥å§“å" style="margin-bottom:10px;">
          
          <label class="input-label">å­¸å“¡ç”Ÿæ—¥</label>
          <input type="date" id="newChildBirth" style="margin-bottom:10px;">
          
          <div style="display:flex; gap:10px;">
             <div style="flex:1;">
               <label class="input-label">å¹´ç´š (é¸å¡«)</label>
               <input type="text" id="newChildGrade" placeholder="ä¾‹: å°äºŒ">
             </div>
             <div style="flex:1;">
               <label class="input-label">å‚™è¨» (é¸å¡«)</label>
               <input type="text" id="newChildNote" placeholder="å‚™è¨»äº‹é …">
             </div>
          </div>
          
          <button class="btn-main btn-green" style="margin-top:15px;" onclick="saveNewChild(event)">å„²å­˜</button>
        </div>
        
        <div style="margin-top:15px; color:var(--primary);">é¸æ“‡ï¼š<strong id="selectedStudentDisplay">æœ¬äºº</strong></div>
      </div>
    </div>
    <div class="bottom-bar">
      <div>
        <div style="font-size:12px; color:#888;">éœ€ä»˜è¨‚é‡‘</div>
        <div style="color:var(--primary); font-weight:bold; font-size:20px;" id="depositPriceDisplay">0 P</div>
        <div style="font-size:11px; color:#999;">é¤˜é¡: <span id="currentBalanceDisplay">--</span></div>
      </div>
      <button id="btnSubmitBooking" class="btn-main btn-green" style="width:auto; padding:10px 30px; border-radius:50px;" onclick="openConfirmModal()">ç¢ºèªé ç´„</button>
    </div>
  </div>

  <div id="custom-modal">
    <div class="modal-box"><h3 id="modal-title" style="margin-top:0;">æ¨™é¡Œ</h3><div id="modal-content"></div><div id="modal-actions" class="modal-btn-group"></div></div>
  </div>

  <div id="page-success" class="page">
    <div class="container" style="text-align:center; padding-top:60px;">
      <div style="width:80px; height:80px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; box-shadow:0 10px 20px rgba(6,199,85,0.3);"><span style="color:white; font-size:40px;">âœ“</span></div>
      <h2 id="success-title" style="color:var(--text); margin-bottom:10px;">é ç´„å®Œæˆï¼</h2>
      <p id="success-desc" style="color:#666; line-height:1.6;">ç³»çµ±è™•ç†ä¸­</p>
      <div class="action-card" id="success-details" style="text-align:left; margin-top:30px; border-left:4px solid var(--primary); display:none;">
        <p style="margin:8px 0;"><strong>æœå‹™ï¼š</strong> <span id="sSvc">--</span></p>
        <p style="margin:8px 0;"><strong>å­¸å“¡ï¼š</strong> <span id="sStu">--</span></p>
        <p style="margin:8px 0;"><strong>æ™‚é–“ï¼š</strong> <span id="sTime">--</span></p>
        <p style="margin:8px 0;"><strong>è¨‚é‡‘ï¼š</strong> <span id="sPrice" style="color:var(--primary);">--</span></p>
      </div>
      <div id="success-btn-group" style="margin-top:30px;"><button class="btn-main btn-green" onclick="switchPage('page-profile')">å›æœƒå“¡ä¸­å¿ƒ</button></div>
    </div>
  </div>

  <script>
    const SERVER_UID = "<?= uidFromUrl ?>"; 
    const SERVER_PAGE = "<?= pageFromUrl ?>";
    const SERVER_NAME = "<?= nameFromUrl ?>"; 
    const SERVER_PIC = "<?= picFromUrl ?>"; 
    
    let currentLineId = SERVER_UID;
    let parentName = ""; 
    let parentBalance = 0; 
    let currentLevel = "VIP1";
    let allServices = [];
    let myChildren = []; 
    
    let selectedServiceIdx = null;
    let selectedDuration = 60;
    let selectedTime = null;
    let selectedStudentName = "æœ¬äºº";
    let finalDeposit = 0; 
    let historyPage = 1;
    let historyTotalPages = 1;

    window.onload = function() {
      if(SERVER_PIC) document.getElementById('profileAvatar').src = SERVER_PIC;
      if(SERVER_NAME) document.getElementById('regName').value = SERVER_NAME;
      setupDefaultDate();
      loadServices();
      checkMemberAndRedirect();
    };

    function checkMemberAndRedirect() {
      google.script.run.withSuccessHandler(res => {
        document.getElementById('page-loading').style.display = 'none';
        if (res.isMember) {
          parentName = res.name; 
          parentBalance = parseInt(res.balance) || 0;
          currentLevel = res.level;
          updateProfileUI(res);
          loadChildren(); 
          loadHistory(); 
          if(document.getElementById('currentBalanceDisplay')) 
             document.getElementById('currentBalanceDisplay').innerText = parentBalance;
          if (SERVER_PAGE === 'booking') switchPage('page-booking');
          else switchPage('page-profile');
        } else {
          switchPage('page-register');
        }
      }).checkMemberStatus(currentLineId);
    }

    function copyMemberCode() {
      let el = document.getElementById('myMemberCode');
      let code = el.getAttribute('data-code');
      if(!code) return;
      navigator.clipboard.writeText(code).then(() => { showToast(); })
        .catch(err => {
           let input = document.createElement('input');
           input.value = code;
           document.body.appendChild(input);
           input.select();
           document.execCommand('copy');
           document.body.removeChild(input);
           showToast();
        });
    }

    function showToast() {
      let toast = document.getElementById("toast-msg");
      toast.className = "show";
      setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function updateProfileUI(res) {
      safeSetText('profileName', res.name);
      safeSetText('profileBalance', res.balance);
      safeSetText('currentBalanceDisplay', res.balance);
      if(res.memberCode) {
         let el = document.getElementById('myMemberCode');
         el.innerHTML = `æ¨è–¦ç¢¼: <span style="font-weight:bold; color:#fff;">${res.memberCode}</span> <span style="font-size:14px; margin-left:5px;">ğŸ“‹</span>`;
         el.setAttribute('data-code', res.memberCode);
      }
      let bg = document.getElementById('memberCardBg');
      let lvl = document.getElementById('profileLevel');
      if(res.level && res.level.includes('VIP1')) { bg.style.background="var(--gold)"; lvl.innerText="ğŸ‘‘ é»ƒé‡‘æœƒå“¡"; bg.style.color="#fff"; }
      else if(res.level && res.level.includes('VIP2')) { bg.style.background="var(--platinum)"; lvl.innerText="ğŸ’ ç™½é‡‘æœƒå“¡"; bg.style.color="#fff"; }
      else if(res.level && res.level.includes('VIP3')) { bg.style.background="var(--diamond)"; lvl.innerText="ğŸ’  é‘½çŸ³æœƒå“¡"; bg.style.color="#fff"; }
      else if(res.level && res.level.includes('VIP4')) { bg.style.background="var(--black-gold)"; lvl.innerText="ğŸ† é»‘é‡‘æœƒå“¡"; bg.style.color="#ffd700"; }
      else { bg.style.background="linear-gradient(135deg, #2ecc71, #06c755)"; lvl.innerText="ä¸€èˆ¬æœƒå“¡"; bg.style.color="#fff"; }
    }

    function saveNewChild(e) {
      if(e) e.preventDefault();
      const name = document.getElementById('newChildName').value;
      const note = document.getElementById('newChildNote').value;
      const birth = document.getElementById('newChildBirth').value;
      const grade = document.getElementById('newChildGrade').value;
      
      if(!name || !birth) return alert("è«‹è¼¸å…¥å§“åèˆ‡ç”Ÿæ—¥");
      
      const btn = event.target;
      btn.innerText = "å„²å­˜ä¸­...";
      
      google.script.run.withSuccessHandler(children => {
        myChildren = children;
        document.getElementById('newChildName').value = '';
        document.getElementById('newChildNote').value = '';
        document.getElementById('newChildBirth').value = '';
        document.getElementById('newChildGrade').value = '';
        btn.innerText = "å„²å­˜";
        selectStudent(name); 
      }).addChild({ lineId: currentLineId, name: name, note: note, birth: birth, grade: grade });
    }

    // --- å…¶ä»–å‡½å¼çœç•¥ (è«‹å‹™å¿…è¤‡è£½ä¸Šä¸€ç‰ˆçš„å®Œæ•´å…§å®¹) ---
    // åŒ…å«: switchPage, loadAllHistory, changePage, loadHistory, loadTopups, openConfirmModal, showTopupFlow, submitTopup, showTransferFlow, submitTransferBooking, doNormalBooking, fillSuccessDetails, closeModal, safeSetText, handleBookingBack, setupDefaultDate, loadServices, selectService, selectDuration, calculateTotal, renderSlots, loadChildren, renderStudentOptions, createBadge, selectStudent, doRegister
    
    // å®Œæ•´è£œé½Šå¦‚ä¸‹ï¼š
    function switchPage(pid) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pid).classList.add('active'); window.scrollTo(0,0); if (pid === 'page-profile') { loadHistory(); google.script.run.withSuccessHandler(res => { if(res.isMember) { parentBalance = parseInt(res.balance) || 0; currentLevel = res.level; updateProfileUI(res); } }).checkMemberStatus(currentLineId); } else if (pid === 'page-topup-history') { loadTopups(); } else if (pid === 'page-all-history') { historyPage = 1; loadAllHistory(historyPage); } }
    function loadAllHistory(page) { document.getElementById('all-history-list').innerHTML = '<div style="text-align:center; color:#999; padding:10px;">è¼‰å…¥ä¸­...</div>'; google.script.run.withSuccessHandler(data => { const container = document.getElementById('all-history-list'); container.innerHTML = ''; historyTotalPages = data.totalPages; document.getElementById('page-indicator').innerText = `${page} / ${historyTotalPages}`; document.getElementById('btn-prev-page').disabled = (page <= 1); document.getElementById('btn-next-page').disabled = (page >= historyTotalPages); if(data.records.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">ç„¡è³‡æ–™</div>'; return; } data.records.forEach(item => { let statusClass = item.status === 'é ç´„æˆåŠŸ' ? 'status-success' : 'status-pending'; let html = `<div class="history-item"><div><div style="font-weight:bold;">${item.service}</div><div style="font-size:12px; color:#888;">${item.date} ${item.time} (${item.student})</div></div><div class="status-badge ${statusClass}">${item.status}</div></div>`; container.innerHTML += html; }); }).getHistoryByPage(currentLineId, page); }
    function changePage(delta) { let newPage = historyPage + delta; if (newPage > 0 && newPage <= historyTotalPages) { historyPage = newPage; loadAllHistory(historyPage); } }
    function loadHistory() { google.script.run.withSuccessHandler(list => { const container = document.getElementById('history-list'); container.innerHTML = ''; if(list.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">å°šç„¡é ç´„ç´€éŒ„</div>'; return; } list.forEach(item => { let statusClass = item.status === 'é ç´„æˆåŠŸ' ? 'status-success' : 'status-pending'; let html = `<div class="history-item"><div><div style="font-weight:bold;">${item.service}</div><div style="font-size:12px; color:#888;">${item.date} ${item.time} (${item.student})</div></div><div class="status-badge ${statusClass}">${item.status}</div></div>`; container.innerHTML += html; }); }).getMemberBookings(currentLineId); }
    function loadTopups() { google.script.run.withSuccessHandler(list => { const container = document.getElementById('topup-list'); container.innerHTML = ''; if(list.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">å°šç„¡å„²å€¼ç´€éŒ„</div>'; return; } list.forEach(item => { let statusClass = (item.status === 'æˆåŠŸ' || item.status === 'Success') ? 'status-success' : 'status-pending'; let html = `<div class="history-item"><div><div style="font-weight:bold; font-size:16px;">$${item.amount}</div><div style="font-size:12px; color:#888;">${item.time}</div></div><div class="status-badge ${statusClass}">${item.status}</div></div>`; container.innerHTML += html; }); }).getMemberTopups(currentLineId); }
    function openConfirmModal() { if(selectedServiceIdx === null) return alert("è«‹é¸æ“‡æœå‹™"); if(!selectedTime) return alert("è«‹é¸æ“‡æ™‚é–“"); const modal = document.getElementById('custom-modal'); const title = document.getElementById('modal-title'); const content = document.getElementById('modal-content'); const actions = document.getElementById('modal-actions'); modal.style.display = 'flex'; if (parentBalance < finalDeposit) { title.innerText = "é¤˜é¡ä¸è¶³"; title.style.color = "var(--red)"; content.innerHTML = `<p style="text-align:center; color:#666;">éœ€ä»˜è¨‚é‡‘ï¼š${finalDeposit} P<br>ç›®å‰é¤˜é¡ï¼š${parentBalance} P<br><span style="color:var(--red); font-weight:bold;">å°šç¼º ${finalDeposit - parentBalance} P</span></p>`; actions.innerHTML = `<button class="btn-main btn-outline" style="flex:1;" onclick="showTopupFlow()">å„²å€¼</button><button class="btn-main btn-green" style="flex:1;" onclick="showTransferFlow()">è½‰å¸³</button>`; return; } title.innerText = "ç¢ºèªé ç´„"; title.style.color = "#333"; let svcName = allServices[selectedServiceIdx].name; content.innerHTML = `<div style="background:#f9f9f9; padding:15px; border-radius:10px; text-align:left;"><strong>å­¸å“¡ï¼š</strong> ${selectedStudentName}<br><strong>æœå‹™ï¼š</strong> ${svcName}<br><strong>æ™‚é–“ï¼š</strong> ${document.getElementById('dateSelect').value} ${selectedTime}<br><hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;"><strong style="color:var(--primary)">è¨‚é‡‘ï¼š${finalDeposit} P</strong></div>`; actions.innerHTML = `<button class="btn-main btn-outline" style="flex:1;" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-main btn-green" style="flex:1;" onclick="doNormalBooking()">ç¢ºå®š</button>`; }
    function showTopupFlow() { document.getElementById('modal-title').innerText = "ç”³è«‹å„²å€¼"; document.getElementById('modal-content').innerHTML = `<div class="bank-info-box"><div class="bank-info-row">éƒµå±€ä»£ç¢¼ï¼š<span class="bank-highlight">700 (ä¸­è¯éƒµæ”¿)</span></div><div class="bank-info-row">å­˜ç°¿å¸³è™Ÿï¼š<span class="bank-highlight">0031157 0431234</span></div><div class="bank-info-row">æˆ¶åï¼š(æ‚¨çš„å§“å)</div></div><p style="font-size:13px; color:#666; text-align:left;">è½‰å¸³å¾Œè«‹è¼¸å…¥é‡‘é¡ï¼Œç­‰å¾…ç¢ºèªã€‚</p><input type="number" id="topupAmount" placeholder="è¼¸å…¥é‡‘é¡ (ä¾‹å¦‚: 1000)" style="margin-top:5px;">`; document.getElementById('modal-actions').innerHTML = `<button class="btn-main btn-outline" style="flex:1;" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-main btn-green" style="flex:1;" onclick="submitTopup()">é€å‡ºç”³è«‹</button>`; document.getElementById('custom-modal').style.display = 'flex'; }
    function submitTopup() { let amt = document.getElementById('topupAmount').value; if(!amt) return alert("è«‹è¼¸å…¥é‡‘é¡"); event.target.innerText = "è™•ç†ä¸­..."; event.target.disabled = true; google.script.run.withSuccessHandler(res => { closeModal(); document.getElementById('success-title').innerText = "ç”³è«‹å·²é€å‡º"; document.getElementById('success-title').style.color = "#f39c12"; document.getElementById('success-desc').innerText = "æˆ‘å€‘æœƒç›¡å¿«ç¢ºèªæ‚¨çš„æ¬¾é …ã€‚"; document.getElementById('success-details').style.display = 'none'; document.getElementById('success-btn-group').innerHTML = `<button class="btn-main btn-outline" style="margin-bottom:10px;" onclick="switchPage('page-profile')">å›æœƒå“¡ä¸­å¿ƒ</button><button class="btn-main btn-green" onclick="switchPage('page-booking')">å»é ç´„èª²ç¨‹</button>`; switchPage('page-success'); }).submitTopup({ lineId: currentLineId, name: parentName, amount: amt }); }
    function showTransferFlow() { document.getElementById('modal-title').innerText = "è½‰å¸³é ç´„"; document.getElementById('modal-content').innerHTML = `<div class="bank-info-box"><div class="bank-info-row">éŠ€è¡Œä»£ç¢¼ï¼š<span class="bank-highlight">822 (ä¸­åœ‹ä¿¡è¨—)</span></div><div class="bank-info-row">éŠ€è¡Œå¸³è™Ÿï¼š<span class="bank-highlight">1234-5678-9012</span></div><div class="bank-info-row">æˆ¶åï¼šæ‚¨çš„å§“å</div></div><p style="font-size:14px; color:var(--red); font-weight:bold; margin-bottom:5px;">æœ¬æ¬¡è¨‚é‡‘ï¼š${finalDeposit} å…ƒ</p><p style="font-size:12px; color:#888; margin-top:0;">*å°¾æ¬¾å°‡æ–¼æœå‹™çµæŸå¾Œæ”¶å–</p><input type="text" id="transferLast5" placeholder="è«‹è¼¸å…¥å¸³è™Ÿæœ«äº”ç¢¼" style="margin-top:10px;">`; document.getElementById('modal-actions').innerHTML = `<button class="btn-main btn-outline" style="flex:1;" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-main btn-green" style="flex:1;" onclick="submitTransferBooking()">é€å‡ºé ç´„</button>`; }
    function submitTransferBooking() { let last5 = document.getElementById('transferLast5').value; if(!last5) return alert("è«‹è¼¸å…¥æœ«äº”ç¢¼"); event.target.innerText = "è™•ç†ä¸­..."; event.target.disabled = true; let bookingData = { lineId: currentLineId, payerName: parentName, studentName: selectedStudentName, serviceName: allServices[selectedServiceIdx].name, price: finalDeposit, last5: last5, duration: selectedDuration, date: document.getElementById('dateSelect').value, time: selectedTime }; google.script.run.withSuccessHandler(res => { closeModal(); document.getElementById('success-title').innerText = "â³ æ”¶æ¬¾ç¢ºèªä¸­"; document.getElementById('success-title').style.color = "#f39c12"; document.getElementById('success-desc').innerHTML = "å·²æ”¶åˆ°è½‰å¸³å›å ±ï¼Œç¢ºèªå¾Œå°‡æ›´æ–°ç‹€æ…‹ã€‚"; fillSuccessDetails(bookingData); document.getElementById('success-details').style.display = 'block'; document.getElementById('success-btn-group').innerHTML = `<button class="btn-main btn-green" onclick="switchPage('page-profile')">å›æœƒå“¡ä¸­å¿ƒ</button>`; switchPage('page-success'); }).makeTransferReservation(bookingData); }
    function doNormalBooking() { let btns = document.querySelectorAll('#modal-actions button'); btns.forEach(b => b.disabled = true); btns[1].innerText = "è™•ç†ä¸­..."; let bookingData = { lineId: currentLineId, payerName: parentName, studentName: selectedStudentName, serviceName: allServices[selectedServiceIdx].name, price: finalDeposit, duration: selectedDuration, date: document.getElementById('dateSelect').value, time: selectedTime }; google.script.run.withSuccessHandler(res => { closeModal(); parentBalance = res.newBalance; updateProfileUI({name:parentName, balance:parentBalance, level:document.getElementById('profileLevel').innerText, memberCode: document.getElementById('myMemberCode').getAttribute('data-code')}); document.getElementById('success-title').innerText = "ğŸ‰ é ç´„æˆåŠŸï¼"; document.getElementById('success-title').style.color = "var(--primary)"; document.getElementById('success-desc').innerText = "è¨‚é‡‘å·²æ‰£é™¤ï¼ŒæœŸå¾…èˆ‡æ‚¨ç›¸è¦‹ã€‚"; fillSuccessDetails(bookingData); document.getElementById('success-details').style.display = 'block'; document.getElementById('success-btn-group').innerHTML = `<button class="btn-main btn-green" onclick="switchPage('page-profile')">å›æœƒå“¡ä¸­å¿ƒ</button>`; switchPage('page-success'); }).makeReservation(bookingData); }
    function fillSuccessDetails(data) { safeSetText('sSvc', data.serviceName); safeSetText('sStu', data.studentName); safeSetText('sTime', `${data.date} ${data.time}`); safeSetText('sPrice', finalDeposit + " P"); }
    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }
    function safeSetText(id, text) { let el = document.getElementById(id); if(el) el.innerText = text; }
    function handleBookingBack() { switchPage('page-profile'); }
    function setupDefaultDate() { const now = new Date(); const offset = now.getTimezoneOffset(); const localDate = new Date(now.getTime() - (offset*60*1000)); let el = document.getElementById('dateSelect'); if(el) { el.value = localDate.toISOString().split('T')[0]; renderSlots(); } }
    function loadServices() { google.script.run.withSuccessHandler(s => { allServices = s; const container = document.getElementById('service-list'); if(!container) return; container.innerHTML = ''; s.forEach((svc, idx) => { let div = document.createElement('div'); div.className = 'service-card'; div.innerHTML = `<span class="svc-name">${svc.name}</span><span class="svc-price">${svc.price} P</span>`; div.onclick = () => selectService(idx, div); container.appendChild(div); }); }).getServices(); }
    function selectService(idx, el) { selectedServiceIdx = idx; document.querySelectorAll('.service-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); calculateTotal(); }
    function selectDuration(mins, el) { selectedDuration = mins; document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); calculateTotal(); }
    function calculateTotal() { if (selectedServiceIdx === null) return; let base = parseInt(allServices[selectedServiceIdx].price); let mult = selectedDuration === 90 ? 1.5 : (selectedDuration === 120 ? 1.75 : 1); let fullPrice = Math.floor(base * mult / 100) * 100; let discountRate = 1; if (currentLevel === 'VIP2') discountRate = 0.95; else if (currentLevel === 'VIP3' || currentLevel === 'VIP4') discountRate = 0.90; let discountedPrice = Math.floor(fullPrice * discountRate); finalDeposit = Math.floor(discountedPrice / 3); let displayPrice = finalDeposit + " P"; if(discountRate < 1) displayPrice += ` <span style="font-size:12px; color:var(--red);">(${Math.round((1-discountRate)*100)}% off)</span>`; document.getElementById('depositPriceDisplay').innerHTML = displayPrice; let balEl = document.getElementById('currentBalanceDisplay'); if(balEl) { if (parentBalance < finalDeposit) balEl.style.color = "var(--red)"; else balEl.style.color = "#999"; } }
    function renderSlots() { let d = document.getElementById('dateSelect').value; if(!d) return; const container = document.getElementById('slotsContainer'); if(!container) return; container.innerHTML = '<div style="grid-column:1/-1;text-align:center;">è¼‰å…¥ä¸­...</div>'; google.script.run.withSuccessHandler(busyList => { container.innerHTML = ''; selectedTime = null; for(let h=9; h<22; h++) { for(let m=0; m<60; m+=30) { let timeStr = (h<10?'0'+h:h) + ':' + (m===0?'00':m); let isBusy = busyList.some(b => b.start === timeStr); let div = document.createElement('div'); div.className = 'time-slot'; div.innerText = timeStr; if(isBusy) div.classList.add('busy'); else { div.onclick = () => { document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected')); div.classList.add('selected'); selectedTime = timeStr; }; } container.appendChild(div); } } }).getBusySlots(d); }
    function loadChildren() { google.script.run.withSuccessHandler(children => { myChildren = children; renderStudentOptions(); }).getChildren(currentLineId); }
    function renderStudentOptions() { const container = document.getElementById('student-container'); if(!container) return; container.innerHTML = ''; container.appendChild(createBadge('æœ¬äºº', 'æœ¬äºº', selectedStudentName === 'æœ¬äºº')); myChildren.forEach(child => { container.appendChild(createBadge(child.name, child.name, selectedStudentName === child.name)); }); let addBtn = document.createElement('div'); addBtn.className = 'badge add'; addBtn.innerText = '+ æ–°å¢'; addBtn.onclick = () => { document.getElementById('new-student-form').style.display = 'block'; }; container.appendChild(addBtn); }
    function createBadge(label, value, isActive) { let div = document.createElement('div'); div.className = 'badge' + (isActive ? ' active' : ''); div.innerText = label; div.onclick = () => selectStudent(value); return div; }
    function selectStudent(name) { selectedStudentName = name; safeSetText('selectedStudentDisplay', name); document.getElementById('new-student-form').style.display = 'none'; renderStudentOptions(); }
    function doRegister() { const name = document.getElementById('regName').value; const phone = document.getElementById('regPhone').value; const birth = document.getElementById('regBirth').value; const referrer = document.getElementById('regReferrer').value; if(!name || !phone || !birth) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™"); google.script.run.withSuccessHandler(res => { alert(res.message); parentName = res.name; parentBalance = parseInt(res.balance); updateProfileUI(res); if(SERVER_PAGE === 'booking') switchPage('page-booking'); else switchPage('page-profile'); }).registerNewMember({ lineId: currentLineId, name: name, phone: phone, birth: birth, referrerCode: referrer }); }
  </script>
</body>
</html>
