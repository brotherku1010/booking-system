<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€£ç·šä¸­...</title>
  <script src="https://static.line-scdn.net/liff/2.22.1/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding-top: 20%; background-color: #f5f5f5; color: #555; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #06c755; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* å¡ä½æ™‚é¡¯ç¤ºçš„æ•‘æ´å€å¡Š */
    #stuck-help { display: none; margin-top: 30px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn-retry { background: #06c755; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    .btn-close { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="loader" id="loading-spinner"></div>
  <h3 id="title-text">æ­£åœ¨è®€å–è³‡æ–™...</h3>
  <div id="status">é©—è­‰èº«åˆ†ä¸­ (v5.0)</div>

  <div id="stuck-help">
    <p style="color:red; font-weight:bold;">âš ï¸ é€£ç·šä¼¼ä¹å¡ä½äº†</p>
    <p style="font-size:14px; text-align:left;">
      å¦‚æœé€™æ˜¯åœ¨ã€Œæˆæ¬ŠåŒæ„ã€å¾Œç™¼ç”Ÿçš„ï¼Œ<br>
      è«‹å˜—è©¦ä»¥ä¸‹æ“ä½œï¼š
    </p>
    <button class="btn-retry" onclick="forceReload()">ğŸ”„ é»æˆ‘å¼·åˆ¶é‡æ•´</button>
    <br><br>
    <p style="font-size:12px; color:#999;">å¦‚æœé‡æ•´ç„¡æ•ˆï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é—œé–‰è¦–çª—ï¼Œå†é‡æ–°é€²å…¥å³å¯ã€‚</p>
    <button class="btn-close" onclick="liff.closeWindow()">âŒ é—œé–‰è¦–çª—</button>
  </div>

  <script>
    const MY_LIFF_ID = "2009054335-tUPGk28q";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxu_ke2CmB51jhdgOP05yb6mBfqwdAIPUQL_IfHmmXwlzaDH3sModbISVHiHUgZToBeWg/exec"; 

    // â˜…â˜…â˜… è¨­å®š 5 ç§’è¶…æ™‚åµæ¸¬ â˜…â˜…â˜…
    // å¦‚æœ 5 ç§’å¾Œé‚„æ²’æˆåŠŸè·³è½‰ï¼Œå°±é¡¯ç¤ºæ•‘æ´å€å¡Š
    const stuckTimer = setTimeout(() => {
      document.getElementById('stuck-help').style.display = 'block';
      document.getElementById('status').innerText = "ç³»çµ±å›æ‡‰é€¾æ™‚";
      document.getElementById('loading-spinner').style.display = 'none';
    }, 5000);

    window.onload = function() {
      loadSDK();
    };

    function loadSDK() {
      var script = document.createElement('script');
      script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
      script.async = true;
      script.onload = initLiff;
      document.head.appendChild(script);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });

        // ç™»å…¥åˆ¤æ–·
        if (!liff.isLoggedIn()) {
          document.getElementById('status').innerText = "è«‹æ±‚æˆæ¬Šä¸­...";
          
          // â˜…â˜…â˜… å„ªåŒ–ï¼šåŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œé¿å… Android åƒåˆ°å£æ‰çš„å¿«å– â˜…â˜…â˜…
          let cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
          let freshUrl = cleanUrl + "?t=" + new Date().getTime(); 
          
          liff.login({ redirectUri: freshUrl });
          return;
        }

        // æˆåŠŸç™»å…¥
        clearTimeout(stuckTimer); // æ¸…é™¤è¶…æ™‚è¨ˆæ™‚å™¨
        
        const profile = await liff.getProfile();
        const userId = profile.userId;
        const displayName = profile.displayName;

        document.getElementById('status').innerText = "é©—è­‰æˆåŠŸï¼Œé€²å…¥ç³»çµ±...";

        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'profile';

        // è·³è½‰
        const targetUrl = `${GAS_URL}?uid=${userId}&page=${page}&name=${encodeURIComponent(displayName)}`;
        window.location.replace(targetUrl);

      } catch (err) {
        // Token å¤±æ•ˆè‡ªå‹•ä¿®å¾©
        var errMsg = err.message.toLowerCase();
        if (errMsg.includes("access token revoked") || errMsg.includes("token")) {
            document.getElementById('status').innerText = "æ­£åœ¨é‡ç½®é€£ç·š...";
            if (liff.isLoggedIn()) liff.logout();
            setTimeout(() => { window.location.reload(); }, 500);
            return;
        }
        alert("éŒ¯èª¤: " + err.message);
      }
    }

    // å¼·åˆ¶é‡æ•´åŠŸèƒ½
    function forceReload() {
      window.location.href = window.location.href.split('?')[0] + "?t=" + new Date().getTime();
    }
  </script>
</body>
</html>
